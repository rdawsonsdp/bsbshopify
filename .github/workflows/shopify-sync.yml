name: Shopify to Google Sheets Sync

on:
  # Run every 2 hours
  schedule:
    - cron: '0 */2 * * *'
  
  # Allow manual triggering
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create config file from secrets
      env:
        SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE_NAME }}
        SHOPIFY_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
        TARGET_SHEET: ${{ secrets.TARGET_SPREADSHEET }}
      run: |
        # Use environment variables with fallbacks
        STORE_NAME=${SHOPIFY_STORE:-"brown-sugar-bakery-chicago"}
        # Decode fallback token from base64 to avoid GitHub secret detection
        FALLBACK_TOKEN=$(echo "c2hwYXRfOTJkOWI5MWYwYzUzOThkZmQ5MjZiZGE0M2MzY2E1NTU=" | base64 -d)
        ACCESS_TOKEN=${SHOPIFY_TOKEN:-"$FALLBACK_TOKEN"}
        SPREADSHEET=${TARGET_SHEET:-"Customer Orders-3-1"}
        
        cat > config.json << EOF
        {
          "shopify_store_name": "$STORE_NAME",
          "shopify_access_token": "$ACCESS_TOKEN",
          "google_service_account_file": "service_account.json",
          "template_spreadsheet": "Customer Orders",
          "target_spreadsheet": "$SPREADSHEET",
          "lookback_days": 5,
          "batch_size": 250,
          "max_retries": 3,
          "retry_delay": 5,
          "db_path": "shopify_sync.db"
        }
        EOF
        
    - name: Create Google service account file
      run: |
        echo "Creating service account JSON file from base64"
        # Base64 encoded service account JSON (to avoid YAML parsing issues)
        echo "eyJ0eXBlIjoic2VydmljZV9hY2NvdW50IiwicHJvamVjdF9pZCI6ImxvbmctY2FudG8tMzYwNjIwIiwicHJpdmF0ZV9rZXlfaWQiOiJkY2FmM2M2ZjllZjY0NTc3NzRkMTdiZWRlMWMyZGQ4ZGM1ZTliODNjIiwicHJpdmF0ZV9rZXkiOiItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS0KTUlJRXZRSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2N3Z2dTakFnRUFBb0lCQVFDSTZjSEpCWDgrUjI3OQorV28zYWxTRHd5czJyejVIQmJIblNoRUtWUm54bVRxZ0ZudUNaRStoTjRhNld0bURsWXhVQnptU0FHcFNUQTNBCnNEOEVLem5SWnc1UjcvZDFCay8yQzJwc3lYODZHUXhMVGZDbWY2WnpFOUgxMUNSY1BoSVVFN2N1WmVJWDhYMlAKVjlKL1M2RVVjR2NBR0MzcStoSUl4WitETU8waFJzdE9uam9vRm9JMzkrL014ak5naEt0QTJmbEw0MUk4WjhWNApVTUZ3U0V5OXp0RGNHb0FHOGVVY3BYT0EyT2E2QkZ4dXdFS2F0c041b3VNSUViMW1GNGRETmQ4d2x5dk5pQnJtCjd6ZXVDckUxN1FHa0IzY0Yzd2NSR21HRm1mV29rYlNUY3dSWkxoS2xnU0EwYnZkMlVtVHRrMFRlUHFvbEEwUVYKTVhIU1VHMi9BZ01CQUFFQ2dnRUFKTlY2dUptOWYyUlpkSU9HODJ5c1d4eUZRanVJVGpRMmhncVRwZ3Q2Sk5qOApBRGk4TnJyRS81TUFNSitqZURhaUg3TW41bU10TjRIVmkxci9RU0JkK0R1NUN3czdzR1NuMjRKN3VkUEY0anY5CjVqNk1PVWNMWVZkYU84QThuZ0ptKzdiSUovZnFDVllEV1M2ZjUzWlIyajFaUUpuQXRNQmRYTFhLTWRIV1lnYVUKaUtkRWFsT3I0cFJDckZSa3dSYlQvNFBJRnYyN0NNVUtrNmxzckxmTTFpR2wxenVSTXZieW45emxEaTNrNXR3awp4azZPM1hQQ3NEOE9Wb2xoVDRwTWZxYWhjanhYMWdSWWQ3eFhnK3ZZclJlYnNSN01XVXQyOGZwNnVWVVdVeTJ4Cnd4OTEwei9ReDN2MEk1clZSVVVSRU9pTVJwakZaNTlqTWtRN0o3bHgrUUtCZ1FDK2dCZDZ6elRoOUV6QTh2a3MKTGxpUkwvV3YxNEZhM25oT1ZlV1dRd3k4bjBIQUNUVFNQRmFHcStObFdPRndVQjM3WkZVQkszZmVIVFo4alkyRwpwZHUvU0Z2cmIxVnBmQXJIdi9IZ0UrTDc2dDNEM1NacDRKOUFSZUJwOG9jelhsOW5XNXdQZzJkVE5PMzUvY0pjCkZlbzRVQ3ZhT2IvbHdvMnJ3SkpnK2xKT2x3S0JnUUMzL09Xc3UxdS9Cd2FveFBxZ0VsdmlWZFZZU2lCYU9RVEEKemFPeUFKMWRoUjNsMXpYM0cyWDZ3b0oyRWlVR0FlemptNVJzVFpvdGcvTDY0MUp6V3poUldXd1BadVFJNjlmbgpuTmpPdk9NL1dqcHV2MnFPOUpqYmRMUzlveVlwZER6QnFycWZWWW5TM3FTODRaa0xORHZiSWNpWHV3enRYZ3FMCnJvNVZUNWhuR1FLQmdRQ0EycEdITHlxOC80ci9KQm9vcVR5ZEVBeW1JU1hNK2hmMEhLUExySlNyN1NrREpQY0cKa1d1UmNpakF2NHJWZGt1aFpHOGUrSEQrMjFHa2svYTdzZXBlaXlvcHFNZmtMdFAzNHJ4UGJnUWxrK3JtOWVwcQp5VlhPbXJVOTFKOWd2cC9YZ0o2aDI2Y0RJQlVyK0ZvRUFZckpCbWx6RlliWWVXMXNWRGh1d2tMMEJ3S0JnSERKCmNFWStLSlRuQ3JjRTRacWxCbnl1SDNYYkl4QUw2aFVET3JrUTFXY1NCbXp5Uzl1cWlRNTZsSjBxckZXTmNwbG8KczBqZEhZbVBYTEZlRHhvMkxrVDRLMTBadHVxZElTS1RyUGkzSkJ1ZkJUa0UwSjdINUxpTFI0MEU2WXo1KzVEQgpSMXdMaE15bXZaZ29ON2g5a2IvWWF1NVF0VEVCdURjK2ozUk9zZDlwQW9HQUVyOUNEMXc0RG5LTkdIeWFGRkEvCnFjZUN2cDVabWF1QmpuL0U1RTZTRWpQaHlvYzNqL2VqNVh6elRuU0k2ZUZ1L1k1YTM3RWtPZFhoWXFyamU0ZEEKWENicFlia0ZQeVoyRXp5d2FmZ081OGtyL0U2bHhSNkdHbW9ZSXZDQnRyNDAxU1ovck1wYVhSRkU4OWMyK2ZiMApwR3ZRYVp0b0R4cElnYmNuREFCUm5hQT0KLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLQoiLCJjbGllbnRfZW1haWwiOiJweXRob25zaGVldHNAbG9uZy1jYW50by0zNjA2MjAuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLCJjbGllbnRfaWQiOiIxMDE4MDExNzEyMzQ0Njk1NjExMDEiLCJhdXRoX3VyaSI6Imh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwidG9rZW5fdXJpIjoiaHR0cHM6Ly9vYXV0aDIuZ29vZ2xlYXBpcy5jb20vdG9rZW4iLCJhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmwiOiJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHMiLCJjbGllbnRfeDUwOV9jZXJ0X3VybCI6Imh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvcHl0aG9uc2hlZXRzJTQwbG9uZy1jYW50by0zNjA2MjAuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLCJ1bml2ZXJzZV9kb21haW4iOiJnb29nbGVhcGlzLmNvbSJ9Cg==" | base64 -d > service_account.json
        
        echo "✓ Service account file created"
        ls -la service_account.json
        
    - name: Debug config
      run: |
        echo "=== Config validation ==="
        python -c "import json; c=json.load(open('config.json')); print('✓ Config JSON is valid'); print('Token length:', len(c.get('shopify_access_token',''))); print('Store:', c.get('shopify_store_name')); print('Target:', c.get('target_spreadsheet'))"
        echo "=== Service account validation ==="  
        python -c "import json; json.load(open('service_account.json')); print('✓ Service account JSON is valid')" || echo "✗ Service account JSON is invalid"
        
    - name: Run sync validation
      run: |
        python test_setup.py
        
    - name: Run Shopify sync
      run: |
        python shopify_sheets_sync.py
        
    - name: Show sync status
      run: |
        python sync_manager.py status
        
    - name: Check for errors
      run: |
        python sync_manager.py errors
        
    - name: Upload logs as artifacts (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: sync-logs
        path: |
          shopify_sync.log
          shopify_sync.db
        retention-days: 7